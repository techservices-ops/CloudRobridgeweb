
#include <WiFi.h>
#include <WiFiManager.h>      
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <ESPmDNS.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SH110X.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SH1106G display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

HardwareSerial GM77(2);
#define RXD2 16
#define TXD2 17

const String deviceId        = "Beta1";
const String deviceName      = "Robridge Scanner Beta2 AI";
const String firmwareVersion = "2.1.0";

String aiServerIP;
uint16_t aiServerPort   = 5000;
String webServerIP;
uint16_t webServerPort  = 3001;
bool     serversFound   = false;

unsigned long lastHeartbeat = 0;
const unsigned long heartbeatInterval = 30000;
bool isRegistered = false;
String deviceIP;

void connectWiFi();
bool discoverServers();
void fallbackPortal();
void registerDevice();
bool sendHeartbeat();
void processBarcode(String bc);
void displayLogo();
void displayReady();
void displayError(String msg);
void displayStatusBar();
void displayScannedBarcode(String bc);
void parseAIResponse(String resp, String bc);
void displayAIResults(String bc, String title, String cat, String desc, String country, bool ok);

const unsigned char epd_bitmap_ro_bridge [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x0f, 0xe0, 0x00, 0x00, 0xff, 0xc0, 0x00, 0x00, 0x78, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x0f, 0xf8, 0x00, 0x00, 0xff, 0xf8, 0x00, 0x00, 0x78, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x0f, 0xfc, 0x00, 0x00, 0xff, 0x3c, 0x00, 0x00, 0x78, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x0f, 0xbe, 0x00, 0x00, 0xff, 0x3e, 0x00, 0x00, 0x78, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x0f, 0xbe, 0x00, 0x00, 0xfe, 0x1e, 0x00, 0x00, 0x30, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x0f, 0x9f, 0x00, 0x00, 0xfe, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x0f, 0x9f, 0x00, 0x00, 0x06, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x0f, 0x1f, 0x00, 0x00, 0x06, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x0f, 0x1f, 0x80, 0x00, 0xfe, 0xff, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x0e, 0x0f, 0x80, 0x00, 0xfc, 0xff, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x0e, 0x0f, 0x80, 0x00, 0xfd, 0xff, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x0e, 0x0f, 0x80, 0xf0, 0x01, 0xff, 0x06, 0x00, 0x70, 0x07, 0x0e, 0x00, 0x60, 0x00, 0x1c, 0x00, 
  0x0e, 0x07, 0x83, 0xfc, 0x03, 0xff, 0x07, 0x3c, 0x70, 0x1f, 0xce, 0x01, 0xf9, 0xc0, 0x7f, 0x00, 
  0x0e, 0x0f, 0x83, 0xfc, 0x7f, 0xff, 0x07, 0x7c, 0x70, 0x1f, 0xce, 0x03, 0xf9, 0xc0, 0x7f, 0x80, 
  0x0e, 0x8f, 0x87, 0xfe, 0x7f, 0xff, 0x07, 0x78, 0x70, 0x3f, 0xee, 0x07, 0xfd, 0xc0, 0xff, 0xc0, 
  0x0f, 0x2f, 0x8f, 0xff, 0x7f, 0xff, 0x07, 0xf8, 0x70, 0x3c, 0xfe, 0x07, 0x9d, 0xc1, 0xe3, 0xc0, 
  0x0f, 0xff, 0x0f, 0x0f, 0x3f, 0x9f, 0x07, 0xf8, 0x70, 0x78, 0x3e, 0x0f, 0x07, 0xc1, 0xc1, 0xe0, 
  0x0e, 0x0f, 0x1e, 0x07, 0x3f, 0x8e, 0x07, 0xc0, 0x70, 0x70, 0x1e, 0x0e, 0x07, 0xc3, 0x80, 0xe0, 
  0x0e, 0x0f, 0x1e, 0x07, 0xbf, 0x8e, 0x07, 0xc0, 0x70, 0x70, 0x1e, 0x1e, 0x03, 0xc3, 0x80, 0xe0, 
  0x0f, 0x0f, 0x1c, 0x03, 0x9f, 0x04, 0x07, 0x80, 0x70, 0xe0, 0x1e, 0x1c, 0x03, 0xc3, 0x80, 0x60, 
  0x0f, 0x1e, 0x1c, 0x03, 0x80, 0x06, 0x07, 0x00, 0x70, 0xe0, 0x0e, 0x1c, 0x01, 0xc3, 0x00, 0x70, 
  0x0f, 0x1e, 0x3c, 0x03, 0x9f, 0x0f, 0x07, 0x00, 0x70, 0xe0, 0x0e, 0x1c, 0x01, 0xc7, 0x00, 0x70, 
  0x0f, 0xfc, 0x38, 0x01, 0xdf, 0x8f, 0x07, 0x00, 0x70, 0xe0, 0x0e, 0x18, 0x01, 0xc7, 0x00, 0x70, 
  0x0f, 0x1c, 0x38, 0x01, 0xdf, 0x8f, 0x07, 0x00, 0x70, 0xe0, 0x0e, 0x18, 0x01, 0xc7, 0x00, 0x70, 
  0x0f, 0x9c, 0x38, 0x01, 0xdf, 0xff, 0x87, 0x00, 0x70, 0xe0, 0x0e, 0x18, 0x01, 0xc7, 0xff, 0xf0, 
  0x0f, 0x9c, 0x38, 0x01, 0xdf, 0xff, 0x87, 0x00, 0x70, 0xe0, 0x0e, 0x18, 0x01, 0xc7, 0xff, 0xf0, 
  0x0f, 0x9c, 0x38, 0x01, 0xdf, 0xff, 0x87, 0x00, 0x70, 0xe0, 0x0e, 0x18, 0x01, 0xc7, 0xff, 0xf0, 
  0x0f, 0x9c, 0x38, 0x01, 0xdf, 0xff, 0x87, 0x00, 0x70, 0xe0, 0x0e, 0x18, 0x01, 0xc7, 0x00, 0x00, 
  0x0f, 0x9e, 0x38, 0x01, 0x83, 0xff, 0x87, 0x00, 0x70, 0xe0, 0x0e, 0x1c, 0x01, 0xc7, 0x00, 0x00, 
  0x0f, 0x9e, 0x3c, 0x03, 0x81, 0xff, 0x87, 0x00, 0x70, 0xe0, 0x0e, 0x1c, 0x01, 0xc7, 0x00, 0x00, 
  0x0f, 0x9e, 0x1c, 0x03, 0x9c, 0xff, 0x87, 0x00, 0x70, 0xe0, 0x0e, 0x1c, 0x01, 0xc3, 0x00, 0x00, 
  0x0f, 0x9e, 0x1c, 0x03, 0x9e, 0xff, 0x87, 0x00, 0x70, 0xe0, 0x1e, 0x1c, 0x03, 0xc3, 0x80, 0x60, 
  0x0f, 0xbe, 0x1e, 0x07, 0xbe, 0x3f, 0x87, 0x00, 0x70, 0x70, 0x1e, 0x0e, 0x03, 0xc3, 0x80, 0xe0, 
  0x0f, 0xbf, 0x1e, 0x07, 0x26, 0x3f, 0x07, 0x00, 0x70, 0x70, 0x1e, 0x0e, 0x07, 0xc3, 0xc0, 0xe0, 
  0x0f, 0x9f, 0x0f, 0x0f, 0x06, 0x1f, 0x07, 0x00, 0x70, 0x78, 0x3e, 0x0f, 0x07, 0xc1, 0xc1, 0xe0, 
  0x0f, 0x9f, 0x0f, 0xff, 0x06, 0x1f, 0x07, 0x00, 0x70, 0x3c, 0x6e, 0x07, 0x9d, 0xc1, 0xf7, 0xc0, 
  0x0f, 0x9f, 0x07, 0xfe, 0x06, 0x3e, 0x07, 0x00, 0x70, 0x3f, 0xee, 0x07, 0xfd, 0xc0, 0xff, 0x80, 
  0x0f, 0x9f, 0x83, 0xfc, 0xc7, 0x3e, 0x07, 0x00, 0x70, 0x1f, 0xce, 0x03, 0xf9, 0xc0, 0xff, 0x80, 
  0x0f, 0x9f, 0x83, 0xf8, 0xe7, 0xfc, 0x07, 0x00, 0x70, 0x0f, 0xce, 0x01, 0xf1, 0xc0, 0x3f, 0x00, 
  0x00, 0x00, 0x00, 0xf0, 0xef, 0xe0, 0x06, 0x00, 0x00, 0x07, 0x00, 0x00, 0x41, 0xc0, 0x1c, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x03, 0x80, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x03, 0x80, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x07, 0x80, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x0f, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfe, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfc, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00

};

void setup() {
  Serial.begin(115200);
  GM77.begin(9600, SERIAL_8N1, RXD2, TXD2);

  if (!display.begin(0x3C, true)) { Serial.println("OLED fail"); while (1); }
  displayLogo();
  connectWiFi();          // WiFiManager portal
  if (!discoverServers()) fallbackPortal();
  registerDevice();
  displayReady();
}

void loop() {
  if (GM77.available()) {
    String bc = GM77.readStringUntil('\n');
    bc.trim();
    if (bc.length()) processBarcode(bc);
  }
  if (millis() - lastHeartbeat > heartbeatInterval) {
    if (sendHeartbeat()) lastHeartbeat = millis();
  }
  delay(100);
}


void connectWiFi() {
  display.clearDisplay();
  displayStatusBar();
  display.setCursor(0, 10);
  display.println("WiFi setup...");
  display.display();

  WiFiManager wm;
  wm.setConfigPortalTimeout(180);          // 3 min
  if (!wm.autoConnect("Robridge-Scanner", "rob123456")) ESP.restart();

  deviceIP = WiFi.localIP().toString();
  Serial.println("\nWiFi connected");
  Serial.println("IP: " + deviceIP);
}

bool discoverServers() {
  display.clearDisplay();
  displayStatusBar();
  display.setCursor(0, 10);
  display.println("Finding servers...");
  display.display();

  int n = MDNS.queryService("http", "tcp");
  for (int i = 0; i < n; ++i) {
    String h = MDNS.hostname(i);
    if (h == "RobridgeAI") {
      aiServerIP   = MDNS.address(i).toString();
      aiServerPort = MDNS.port(i);
    }
    if (h == "RobridgeWeb") {
      webServerIP   = MDNS.address(i).toString();
      webServerPort = MDNS.port(i);
    }
  }
  serversFound = aiServerIP.length() && webServerIP.length();
  return serversFound;
}

void fallbackPortal() {
  Serial.println("mDNS failed â€“ fallback portal");
  WiFiManager wm;
  WiFiManagerParameter customAI("aiip", "AI server IP:port", "192.168.1.42:5000", 64);
  WiFiManagerParameter customWeb("webip", "Web server IP:port", "192.168.1.42:3001", 64);
  wm.addParameter(&customAI);
  wm.addParameter(&customWeb);
  wm.setConfigPortalTimeout(0);   // block until done
  wm.startConfigPortal("Robridge-Setup", "rob123456");

  String aiFull = String(customAI.getValue());
  String webFull= String(customWeb.getValue());
  int colon;
  colon = aiFull.indexOf(':');  aiServerIP  = aiFull.substring(0, colon);
  aiServerPort= aiFull.substring(colon+1).toInt();
  colon = webFull.indexOf(':'); webServerIP = webFull.substring(0, colon);
  webServerPort=webFull.substring(colon+1).toInt();
}

void registerDevice() {
  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  String url = "http://" + webServerIP + ":" + String(webServerPort) + "/api/esp32/register";
  http.begin(url);
  http.addHeader("Content-Type", "application/json");

  StaticJsonDocument<512> doc;
  doc["deviceId"]        = deviceId;
  doc["deviceName"]      = deviceName;
  doc["ipAddress"]       = deviceIP;
  doc["firmwareVersion"] = firmwareVersion;
  doc["status"]          = "online";
  doc["lastSeen"]        = millis();

  String payload; serializeJson(doc, payload);
  int code = http.POST(payload);
  isRegistered = (code == 200);
  http.end();
}

bool sendHeartbeat() {
  if (!isRegistered) { registerDevice(); return false; }

  HTTPClient http;
  String url = "http://" + webServerIP + ":" + String(webServerPort) + "/api/esp32/ping/" + deviceId;
  http.begin(url);
  http.addHeader("Content-Type", "application/json");

  StaticJsonDocument<256> doc;
  doc["timestamp"] = millis();
  doc["status"]    = "online";
  doc["ipAddress"] = deviceIP;

  String payload; serializeJson(doc, payload);
  int code = http.POST(payload);
  http.end();
  if (code != 200) isRegistered = false;
  return code == 200;
}

void processBarcode(String bc) {
  Serial.println("Scanned: " + bc);
  displayScannedBarcode(bc);

  if (WiFi.status() != WL_CONNECTED) { displayError("WiFi down"); return; }

  HTTPClient http;
  String url = "http://" + aiServerIP + ":" + String(aiServerPort) + "/api/esp32/scan";
  http.begin(url);
  http.addHeader("Content-Type", "application/json");

  StaticJsonDocument<512> doc;
  doc["barcodeData"] = bc;
  doc["deviceId"]    = deviceId;
  doc["deviceName"]  = deviceName;
  doc["scanType"]    = "GM77_SCAN";
  doc["timestamp"]   = millis();

  String payload; serializeJson(doc, payload);
  int code = http.POST(payload);
  if (code == 200) {
    String resp = http.getString();
    parseAIResponse(resp, bc);
  } else {
    displayError("AI srv " + String(code));
  }
  http.end();

  url = "http://" + webServerIP + ":" + String(webServerPort) + "/api/esp32/scan/" + deviceId;
  http.begin(url);
  http.addHeader("Content-Type", "application/json");
  serializeJson(doc, payload);
  http.POST(payload);
  http.end();
}

void displayLogo() {
  display.clearDisplay();
  display.drawBitmap(0, 0, epd_bitmap_ro_bridge, 128, 64, 1);
  display.display();
  delay(3000);
}

void displayReady() {
  display.clearDisplay();
  displayStatusBar();
  display.setTextSize(1);
  display.setTextColor(SH110X_WHITE);
  display.setCursor(0, 10);
  display.println("Robridge Scanner");
  display.setCursor(0, 20);
  display.println("Ready to scan");
  display.setCursor(0, 30);
  display.println("Device: " + deviceId);
  display.display();
}

void displayError(String msg) {
  display.clearDisplay();
  displayStatusBar();
  display.setCursor(0, 10);
  display.println("Error: " + msg);
  display.display();
  delay(3000);
  displayReady();
}

void displayScannedBarcode(String bc) {
  display.clearDisplay();
  displayStatusBar();
  display.setTextSize(1);
  display.setTextColor(SH110X_WHITE);
  display.setCursor(0, 10);
  display.println("Scanned:");
  display.setCursor(0, 20);
  display.println(bc.length() > 16 ? bc.substring(0, 16) : bc);
  display.setCursor(0, 50);
  display.println("Sending...");
  display.display();
}

void parseAIResponse(String resp, String bc) {
  StaticJsonDocument<1024> doc;
  if (deserializeJson(doc, resp)) { displayError("AI json"); return; }

  String title = doc["title"] | "Unknown";
  String cat   = doc["category"] | "Unknown";
  String desc  = doc["description"] | "No desc";
  String cntry = doc["country"] | "";

  // page 1
  display.clearDisplay();
  displayStatusBar();
  display.setCursor(0, 10);
  display.println("AI: " + title.substring(0, 16));
  display.setCursor(0, 20);
  display.println("Cat: " + cat.substring(0, 16));
  if (cntry.length()) {
    display.setCursor(0, 30);
    display.println("Country: " + cntry);
  }
  display.display();
  delay(5000);

  // page 2
  display.clearDisplay();
  displayStatusBar();
  display.setCursor(0, 10);
  display.println("Description:");
  display.setCursor(0, 20);
  display.println(desc.substring(0, 64));
  if (desc.length() > 64) {
    display.setCursor(0, 30);
    display.println(desc.substring(64, 128));
  }
  display.display();
  delay(8000);
  displayReady();
}

void displayStatusBar() {
  display.drawLine(0, 8, 127, 8, SH110X_WHITE);
  // WiFi
  if (WiFi.status() == WL_CONNECTED) {
    display.fillRect(2, 5, 2, 2, SH110X_WHITE);
    display.fillRect(5, 3, 2, 4, SH110X_WHITE);
    display.fillRect(8, 1, 2, 6, SH110X_WHITE);
    display.fillRect(11, 0, 2, 7, SH110X_WHITE);
  } else {
    display.drawLine(2, 0, 12, 7, SH110X_WHITE);
    display.drawLine(12, 0, 2, 7, SH110X_WHITE);
  }
  // Battery placeholder
  display.drawRect(110, 1, 14, 6, SH110X_WHITE);
  display.fillRect(124, 3, 2, 2, SH110X_WHITE);
  display.fillRect(112, 3, 10, 2, SH110X_WHITE);
  // Device ID
  display.setTextSize(1);
  display.setTextColor(SH110X_WHITE);
  display.setCursor(45, 0);
  display.print(deviceId);
}